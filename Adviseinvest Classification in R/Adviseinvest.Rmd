---
title: "Project: Model Evaluation and Deployment"
author: " "
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(rpart)

```

Notes on compiling this document:  

- Change the information in the yaml header above:  title and author.
- Make sure the output argument is set correctly.  It should read: output: html_document or output: word_document.
- Once you are finished writing the code necessary to answer the questions in the quiz, clear your environment by clicking on the broom icon in the environment pane (upper right quadrant).
- Run each code chunk individually (click the green arrow icon in the upper right of the chunk). Start at the top of this document and proceed sequentially to the bottom.  Fix any code errors you find.  
- Once your code is error-free, click "knit" in the menu above. Your document should compile to HTML, if the output is set to "html_document" (or to word if the output is set to "word_document").

In the code chunk above (entitled "setup") echo is set to TRUE.  This means that the code in your chunks will be displayed, along with the results, in your compiled document.

## Load and Transform Data

Below is code to clean and prepare the dataset for modeling. Before running that code, follow these preparatory steps:

1. Download the RMarkdown template and the datasets for the assignment from Canvas.  

2. Copy or move these files from your downloads folder to a folder dedicated to this class--say, MKTG-6487.

3. You need to define this folder as your "working directory."  To do so, navigate to that folder using the files tab in the lower right quadrant in RStudio.  (You should see your files you moved into this folder in the previous step.) Click the "More" button in the menu under the Files tab and select "Set As Working Directory."

Once the files are in the right location on your computer then run this code to clean and format the data:

```{r}
# You must run this code to format the dataset properly!

advise_invest <- read_csv("adviseinvest.csv")  %>%            # Download data
  select(-product) %>%                                        # Remove the product column
  na.omit %>%                                                 # Remove NAs
  filter(income > 0,                                          # Filter out mistaken data
         num_accts < 5) %>% 
  mutate(answered = factor(ifelse(answered==0, "no","yes"),   # Turn answered into yes/no factor
                           levels  = c("no", "yes")),
         female = factor(female),                             # Make categorical variables into factors
         job = factor(job),
         rent = factor(rent),
         own_res = factor(own_res),
         new_car = factor(new_car),
         mobile = factor(mobile),
         chk_acct = factor(chk_acct),
         sav_acct = factor(sav_acct)) 

```

And here is code to load the dataset of prospective customers from your working directory. Note that in order to use this dataset for prediction, the variables need to be formatted exactly the same as in the data used to fit the model. It does not include a target variable because the event of answering  or not answering has not happened yet for scheduled customers.

```{r}
prospective <- read_csv("customer_data.csv") %>% 
  mutate(female = factor(female),
         job = factor(job),
         rent = factor(rent),
         own_res = factor(own_res),
         new_car = factor(new_car),
         mobile = factor(mobile),
         chk_acct = factor(chk_acct),
         sav_acct = factor(sav_acct)) 
prospective
```


## Questions

One of the simplifying assumptions we will make in this project is that all the customers who answer the phone will purchase a product. (This assumption is actually verified by the data.) To model "answered" in this case is therefore equivalent to modeling "purchased."

There are costs and benefits in this case. We will assume that customers purchase a product for \$100 dollars. This was the average cost of AdviseInvest products, according to the Director of Sales.  Also, as we learned in the interview, the agent time to make the sale is worth \$25. Profit would therefore be \$75 dollars for an answered call and a purchase. In sum:

**Benefit**: True positive. The customer is predicted to answer, does answer, and purchases a product for \$100 for a profit of 100 - 25 = \$75.

**Cost**: False positive. The customer is predicted to answer, but does not answer, so there is a loss of \$25. (We assume the agent cannot schedule another call at the last minute, or spends the entire time slot trying to make the call.)

For this exercise, we propose that customers who are not predicted to answer will not be called, so there would be no benefits and no costs for them.  

However, this proposal is for illustration only.  Below you will be asked to come up with a final recommendation for the Director of Sales, and you should feel free to craft a solution---whatever that might be---that fits the details of the case.

One thing to keep in mind for this final phase of the project is that a predictive model is always developed using historical data.  The end goal, however, is to predict the future occurrence of the event that has been modeled. In this exercise, you will practice using data on new customers---that is, customers who have not yet been called---to predict whether they will answer. How you use these predictions in solving the business problem is up to you.

### Q1. 

Fit a tree model of `answered` using all the available predictors. This is the model from the previous module's project; you are welcome to cut and paste your code.  As instructed there, do not use `product` as a predictor, and make sure to change the indicators and the outcome into factors.

Create a confusion matrix for this model, using the `predict()` function with the `type = "class"` argument. (The default probability threshold used by the function is .5.)

1. What is the number of true positives (TP)?
2. What is the number of false positives (FP)?
3. What is the number of true negatives (TN)?
4. What is the number of false negatives (FN)?

Note that due to mismatched factor levels the location of the cells in the confusion matrix may have gotten switched around. The numbers are accurate, but you must take care to identify which cells contain TP, FP, TN and FN.

```{r}
(tree_model <- rpart(formula = answered ~ .,
                     data = advise_invest))

confusion_matrix_class <- table(predicted = predict(tree_model, type = "class"),
      observed = advise_invest$answered)
confusion_matrix_class
```


### Q2

Using the confusion matrix in the previous question how much profit (revenue - costs) could be expected with these costs and benefits? To do the calculation use the cost-benefit matrix defined in the following chunk:


```{r}

(cost_benefit <-  matrix(c(75, 0, -25, 0), ncol = 2,
                         dimnames = list(c("predicted yes", "no"), 
                                         c("observed yes","no"))))
a <- 13820 *75
a
b <- 3006 * -25
b
a + b
```

Hint: multiply the values in the confusion matrix cells by the the cost-benefit matrix cells. Careful: profit should not be negative! Make sure that you have correctly identified the true positives and the false positives in your confusion matrix. It will be easiest to calculate profit by hand.

### Q3

How much profit (revenue - costs) could be expected if all customers are called? We can consider this a baseline case for profit since it does not require a model.

In other words, to calculate profit in this baseline scenario treat the customers who answer as true positives treat the customers who do not answer as false positives.

```{r}
yes <- 2304 + 13820
no <- 10367 + 3008
yes_cost <- yes * 75
no_cost <- no * -25
yes_cost + no_cost
```

### Q4

How much profit (revenue - costs) would we expect with the classification tree model from above using a class decision threshold of .3?  (.3 is the threshold that produces maximum profit.)

Hint: use the cost-benefit matrix provided above, but create a new confusion matrix using `predict()` with the `type = "prob"` argument. You will need to convert the resulting probabilities into class labels using the threshold of .3.  In other words, if the model-predicted probability of answering is greater than or equal to .3, then assign a label of "yes." Again, make sure that you have correctly identified the true positives and the false positives in your confusion matrix and that you are multiplying these by the values in the correct cells in the cost-benefit matrix.

```{r}
table(predicted = ifelse(predict(tree_model, type = "prob")[,2] > .3, "YES", "NO"),
      observed = advise_invest$answered)
yes <- 14268 * 75
no <- 3776 * 25
yes - no
```

### Q5

The second data set for this assignment (loaded above as "prospective") contains observations for prospective customers. There is no target variable in this dataset because these customers have not yet been called. 

Steps: 

1. Use the supervised model you created for the first question to predict a probability of answering for each prospective customer. 

2. Assign a predicted class label of "yes" to every customer whose model-estimated probability of answering is .3 or greater. (This is the optimal class decision threshold.) 

3. Filter the dataset to contain only prospective customers with a predicted class label of "yes." This is your contact list. 

How many customers are on the list?


```{r}
(answer_model <- rpart(answered ~., data = advise_invest))
glimpse(prospective)
predict(answer_model,
        newdata = prospective,
        type = "prob") %>%
  head
```


```{r}
predictions <- prospective %>%
  select(customer_id) %>%
  mutate(answer_prob = predict(answer_model,
                                newdata = prospective,
                                type = "prob")[,2])
predictions
```
```{r}
contact_list <- predictions %>%
  filter(answer_prob >= .3) %>%
  arrange(desc(answer_prob))

glimpse(contact_list)
```


### Q6

Write a paragraph or two in which you clearly describe **and argue for** your recommendations. You will be graded on the extent to which you are able to:

Describe the business problem and persuasively present your results as a solution, discussing the details of how your predictive modeling results would be used/implemented by the Director of Sales to improve operations.
Write clearly and compellingly without mistakes (such as spelling errors) and without relying on jargon. The Director of Sales is knowledgeable about analytics but is not an expert statistician. You should therefore clearly explain terms such as (but not limited to): classification tree model, customer segmentation, accuracy, true positives, false positives, cost-benefit matrix, confusion matrix, class labels, probability.

Feel free to produce additional analytics if you think it would help you make your case.

